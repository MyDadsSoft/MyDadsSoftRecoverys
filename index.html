<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyDadsSoft Recoverys</title>
<link rel="stylesheet" href="/styles.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
<script src="https://www.paypal.com/sdk/js?client-id=AcEJpJURRXbxavTwWGd9bqyrAKDoGpZf8zBhDFOnhdsD8IWFOctPEBtJzoKxBIlwmF0rJHQ2EYQkJtRo"></script>
</head>
<body>
<header>
  <h1>MyDadsSoft Recoverys</h1>
  <p>GTA V Account Boosting & Safe Recoveries Since 2013</p>
</header>

<section class="card">
  <h2>Order a Boost / Recovery</h2>
  <form id="orderForm">
    <label>Email <input type="email" id="email" required></label>
    <label>Discord <input type="text" id="discord" required></label>
    <label>Platform <select id="platform"><option>PC</option></select></label>
    <label>Package
      <select id="package">
        <option value="5">10 Million — £5</option>
        <option value="15">50 Million — £15</option>
        <option value="25">100 Million — £25</option>
        <option value="custom">Custom Amount</option>
      </select>
    </label>
    <label id="customAmountContainer" style="display:none;">Custom Amount (GBP) <input type="number" id="customAmount" min="1"></label>
    <label>Transfer Method
      <select id="transferMethod">
        <option value="screenshare">Screen-share</option>
        <option value="onetimelink">One-time URL</option>
        <option value="discord_dm">Discord DM</option>
      </select>
    </label>
  </form>

  <div id="paypal-button-container" style="margin-top:30px;"></div>
</section>

<script>
const form = document.getElementById('orderForm');
const pkg = document.getElementById('package');
const customC = document.getElementById('customAmountContainer');

// Show custom amount input if selected
pkg.addEventListener('change', () => {
  customC.style.display = pkg.value === 'custom' ? 'block' : 'none';
});

// Detect user currency
async function getUserCurrency() {
  try {
    const res = await fetch('https://ipapi.co/json/');
    const data = await res.json();
    return data.currency || 'GBP';
  } catch { return 'GBP'; }
}

// Convert GBP to user currency
async function convertPriceGBPTo(amountGBP, currency) {
  if (currency === 'GBP') return amountGBP;
  const res = await fetch(`https://api.exchangerate.host/convert?from=GBP&to=${currency}&amount=${amountGBP}`);
  const data = await res.json();
  return data.result;
}

// Initialize PayPal buttons once
paypal.Buttons({
  style: { shape: 'pill', color: 'purple', layout: 'vertical', label: 'pay' },

  onClick: async (data, actions) => {
    // Validate required fields
    if (!form.email.value || !form.discord.value) {
      alert('Please fill in all required fields!');
      return actions.reject();
    }
    return actions.resolve();
  },

  createOrder: async (data, actions) => {
    const amountGBP = pkg.value === 'custom' ? Number(document.getElementById('customAmount').value) : Number(pkg.value);
    const currency = await getUserCurrency();
    const amount = await convertPriceGBPTo(amountGBP, currency);
    return actions.order.create({
      purchase_units: [{ amount: { value: amount.toFixed(2), currency_code: currency } }]
    });
  },

  onApprove: async (data, actions) => {
    const details = await actions.order.capture();
    alert(`Payment successful: ${details.payer.name.given_name} (${details.purchase_units[0].amount.currency_code} ${details.purchase_units[0].amount.value})`);
    // Send order info to backend
    await fetch('/functions/paypal-webhook', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderID: details.id,
        email: form.email.value,
        discord: form.discord.value,
        platform: form.platform.value,
        transferMethod: form.transferMethod.value,
        package: pkg.value
      })
    });
  },

  onError: err => {
    console.error(err);
    alert('PayPal checkout failed. Try again.');
  }
}).render('#paypal-button-container');
</script>
</body>
</html>
