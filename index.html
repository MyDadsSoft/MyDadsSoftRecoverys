<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyDadsSoft Recoverys</title>
<script src="https://www.paypal.com/sdk/js?client-id=AcEJpJURRXbxavTwWGd9bqyrAKDoGpZf8zBhDFOnhdsD8IWFOctPEBtJzoKxBIlwmF0rJHQ2EYQkJtRo"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f4f4f4;
  color: #333;
  margin: 0;
  padding: 0;
}
header {
  text-align: center;
  padding: 2em;
  background-color: #222;
  color: #fff;
}
header h1 { margin: 0; font-size: 2em; }
header p { margin: 0.5em 0 0; }

.card {
  background: #fff;
  padding: 2em;
  margin: 2em auto;
  border-radius: 10px;
  max-width: 600px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

label { display:block; margin:1em 0 0.5em; font-weight: bold; }
input, select {
  width:100%; padding:10px; border-radius:5px; border:1px solid #ccc;
}

#paypal-button-container { margin-top: 20px; }

#customAmountContainer { display: none; }
</style>
</head>
<body>

<header>
  <h1>MyDadsSoft Recoverys</h1>
  <p>GTA V Account Boosting & Safe Recoveries Since 2013</p>
</header>

<section class="card">
  <h2>Order a Boost / Recovery</h2>
  <form id="orderForm">
    <label>Email <input type="email" id="email" required></label>
    <label>Discord <input type="text" id="discord" required></label>
    <label>Platform <select id="platform"><option>PC</option></select></label>
    <label>Package
      <select id="package">
        <option value="5">10 Million — £5</option>
        <option value="15">50 Million — £15</option>
        <option value="25">100 Million — £25</option>
        <option value="custom">Custom Amount</option>
      </select>
    </label>
    <label id="customAmountContainer">Custom Amount (GBP) <input type="number" id="customAmount" min="1"></label>
    <label>Transfer Method
      <select id="transferMethod">
        <option value="screenshare">Screen-share</option>
        <option value="onetimelink">One-time URL</option>
        <option value="discord_dm">Discord DM</option>
      </select>
    </label>
  </form>

  <div id="paypal-button-container"></div>
</section>

<script>
const form = document.getElementById('orderForm');
const pkg = document.getElementById('package');
const customC = document.getElementById('customAmountContainer');

pkg.addEventListener('change', () => {
  customC.style.display = pkg.value === 'custom' ? 'block' : 'none';
});

async function getUserCurrency() {
  try { const res = await fetch('https://ipapi.co/json/'); const data = await res.json(); return data.currency || 'GBP'; } catch { return 'GBP'; }
}

async function convertPriceGBPTo(amountGBP, currency) {
  if(currency === 'GBP') return amountGBP;
  const res = await fetch(`https://api.exchangerate.host/convert?from=GBP&to=${currency}&amount=${amountGBP}`);
  const data = await res.json();
  return data.result;
}

// Render PayPal button once
paypal.Buttons({
  style: { layout: 'vertical', shape: 'rect', color: 'gold', label: 'pay' },
  onClick: async (data, actions) => {
    if(!form.email.value || !form.discord.value) { alert('Please fill in all required fields!'); return actions.reject(); }
    return actions.resolve();
  },
  createOrder: async (data, actions) => {
    const amountGBP = pkg.value === 'custom' ? Number(document.getElementById('customAmount').value) : Number(pkg.value);
    const currency = await getUserCurrency();
    const amount = await convertPriceGBPTo(amountGBP, currency);
    return actions.order.create({
      purchase_units: [{ amount: { value: amount.toFixed(2), currency_code: currency } }]
    });
  },
  onApprove: async (data, actions) => {
    const details = await actions.order.capture();
    confetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });
    alert(`Payment successful: ${details.payer.name.given_name} (${details.purchase_units[0].amount.currency_code} ${details.purchase_units[0].amount.value})`);
    await fetch('/functions/paypal-webhook', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        orderID: details.id,
        email: form.email.value,
        discord: form.discord.value,
        platform: form.platform.value,
        transferMethod: form.transferMethod.value,
        package: pkg.value
      })
    });
  },
  onError: err => { console.error(err); alert('PayPal checkout failed.'); }
}).render('#paypal-button-container');
</script>

</body>
</html>
