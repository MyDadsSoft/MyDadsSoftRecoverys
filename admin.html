<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Admin</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; }
  input, select, button { margin: 5px 0; padding: 5px; width: 100%; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f4f4f4; }
</style>
</head>
<body>

<h1>Friends & Family Orders Admin</h1>

<h2>Log New Order</h2>
<form id="logOrderForm">
  <input type="email" id="email" placeholder="Customer Email" required>
  <input type="text" id="discord" placeholder="Discord (optional)">
  <input type="text" id="platform" placeholder="Platform (optional)">
  <input type="text" id="package" placeholder="Package (optional)">
  <input type="text" id="transferMethod" placeholder="Transfer Method (optional)">
  <button type="submit">Log Order</button>
</form>

<h2>All Orders</h2>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Email</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="ordersTable">
    <tr><td colspan="4">Loading orders...</td></tr>
  </tbody>
</table>

<script>
const LOG_ORDER_URL = '/functions/log-order'; // adjust to your Worker path
const GET_ORDERS_URL = '/functions/get-orders';
const UPDATE_ORDER_URL = '/functions/update-order';

// Function to generate a unique order ID
function generateOrderId() {
  const timestamp = Date.now().toString(36); // time-based unique string
  const random = Math.random().toString(36).substring(2, 6); // random string
  return `ORD-${timestamp}-${random}`;
}

async function fetchOrders() {
  const res = await fetch(GET_ORDERS_URL);
  const orders = await res.json();
  const tbody = document.getElementById('ordersTable');
  if (!orders || orders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4">No orders found.</td></tr>';
    return;
  }

  tbody.innerHTML = orders.map(order => `
    <tr>
      <td>${order.id}</td>
      <td>${order.email}</td>
      <td>${order.status}</td>
      <td>
        <select onchange="updateStatus('${order.id}', this.value)">
          <option value="">--Change Status--</option>
          <option value="paid">Paid</option>
          <option value="delivered">Delivered</option>
          <option value="completed">Completed</option>
        </select>
      </td>
    </tr>
  `).join('');
}

async function updateStatus(orderId, status) {
  if (!status) return;
  await fetch(UPDATE_ORDER_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ orderId, status })
  });
  fetchOrders();
}

document.getElementById('logOrderForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = generateOrderId();
  const email = document.getElementById('email').value;
  const discord = document.getElementById('discord').value;
  const platform = document.getElementById('platform').value;
  const pkg = document.getElementById('package').value;
  const transferMethod = document.getElementById('transferMethod').value;

  await fetch(LOG_ORDER_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, email, discord, platform, package: pkg, transferMethod, status: 'paid' })
  });

  document.getElementById('logOrderForm').reset();
  fetchOrders();
});

// Load orders on page load
fetchOrders();
</script>

</body>
</html>
